import React, { useState, useEffect, useCallback } from 'react';

// Interface para obst√°culos
interface Obstacle {
  id: number;
  x: number;
  y: number;
  type: 'bus' | 'animal';
}

// Interface para pontos (opcional, mas boa pr√°tica)
interface Point {
  id: number;
  x: number;
  y: number;
  collected: boolean;
}

const RacingGame: React.FC = () => {
  // Estados do jogo
  const [carPosition, setCarPosition] = useState<number>(50); // 0-100%
  const [score, setScore] = useState<number>(0);
  const [gameSpeed, setGameSpeed] = useState<number>(5);
  const [points, setPoints] = useState<Point[]>([]);
  const [obstacles, setObstacles] = useState<Obstacle[]>([]);
  const [isGameRunning, setIsGameRunning] = useState<boolean>(false);
  const [isMobile, setIsMobile] = useState<boolean>(false);

  // Detectar dispositivo
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768 || 'ontouchstart' in window);
    };
    
    checkMobile();
    window.addEventListener('resize', checkMobile);
    
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // Inicializar jogo
  const startGame = useCallback(() => {
    setIsGameRunning(true);
    setScore(0);
    setCarPosition(50);
    setPoints([]);
    setObstacles([]); // Limpar obst√°culos tamb√©m
    setGameSpeed(5);
  }, []);

  // Gerar pontos e obst√°culos na pista
  useEffect(() => {
    if (!isGameRunning) return;

    const pointGenerator = setInterval(() => {
      setPoints(prev => [
        ...prev,
        {
          id: Date.now(),
          x: Math.random() * 80 + 10, // 10-90%
          y: -20,
          collected: false
        }
      ]);
    }, 1500);

    const obstacleGenerator = setInterval(() => {
      setObstacles(prev => [
        ...prev,
        {
          id: Date.now(),
          x: Math.random() * 70 + 15, // 15-85%
          y: -50,
          type: Math.random() > 0.5 ? 'bus' : 'animal'
        }
      ]);
    }, 2000);

    return () => {
      clearInterval(pointGenerator);
      clearInterval(obstacleGenerator);
    };
  }, [isGameRunning]);

  // Movimentar pontos/obst√°culos e verificar colis√µes
  useEffect(() => {
    if (!isGameRunning) return;

    const gameLoop = setInterval(() => {
      // Movimentar pontos para baixo
      setPoints(prev => 
        prev.map(point => ({
          ...point,
          y: point.y + gameSpeed
        }))
        .filter(point => point.y < 120) // Remover pontos que sa√≠ram da tela
      );

      // Movimentar obst√°culos para baixo
      setObstacles(prev => 
        prev.map(obstacle => ({
          ...obstacle,
          y: obstacle.y + gameSpeed
        }))
        .filter(obstacle => obstacle.y < 150) // Remover obst√°culos que sa√≠ram da tela
      );

      // Verificar colis√µes com pontos
      setPoints(prev => 
        prev.map(point => {
          if (!point.collected && 
              point.y > 60 && point.y < 80 && // Zona de colis√£o vertical
              Math.abs(point.x - carPosition) < 10) { // Zona de colis√£o horizontal
            setScore(s => s + 10);
            return { ...point, collected: true };
          }
          return point;
        })
      );

      // Verificar colis√µes com obst√°culos
      obstacles.forEach(obstacle => {
        if (obstacle.y > 60 && obstacle.y < 80 && // Zona de colis√£o vertical
            Math.abs(obstacle.x - carPosition) < 15) { // Zona de colis√£o horizontal
          setScore(0); // Perde todos os pontos
          setObstacles(prev => prev.filter(obs => obs.id !== obstacle.id));
          // Opcional: Adicionar feedback visual (ex: shake da tela)
        }
      });

      // Aumentar dificuldade
      if (score > 0 && score % 50 === 0) {
        setGameSpeed(s => Math.min(s + 0.5, 15));
      }
    }, 50);

    return () => clearInterval(gameLoop);
  }, [isGameRunning, carPosition, gameSpeed, score, obstacles]);

  // Controles do teclado
  useEffect(() => {
    if (!isGameRunning || isMobile) return;

    const handleKeyPress = (e: KeyboardEvent) => {
      if (e.key === 'ArrowLeft') {
        setCarPosition(p => Math.max(10, p - 3));
      } else if (e.key === 'ArrowRight') {
        setCarPosition(p => Math.min(90, p + 3));
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [isGameRunning, isMobile]);

  // Controles touch
  const handleTouchControl = (direction: 'left' | 'right') => {
    if (!isGameRunning) return;
    
    if (direction === 'left') {
      setCarPosition(p => Math.max(10, p - 5));
    } else {
      setCarPosition(p => Math.min(90, p + 5));
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-blue-100 to-green-100 p-4">
      {/* Placar */}
      <div className="bg-white rounded-lg shadow-lg p-4 mb-6 w-full max-w-md">
        <h1 className="text-2xl font-bold text-center text-gray-800 mb-2">Corrida dos Pontos</h1>
        <div className="text-center">
          <span className="text-3xl font-bold text-blue-600">Pontua√ß√£o: {score}</span>
        </div>
      </div>

      {/* √Årea do Jogo */}
      <div className="relative w-full max-w-md h-96 bg-gray-800 rounded-lg overflow-hidden shadow-2xl">
        {/* Pista */}
        <div className="absolute inset-0 bg-gray-700">
          {/* Linhas da pista */}
          <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-1 h-full bg-yellow-300 dashed-line"></div>
        </div>

        {/* Pontos */}
        {points.map(point => (
          !point.collected && (
            <div
              key={point.id}
              className="absolute w-6 h-6 bg-yellow-400 rounded-full shadow-lg transform -translate-x-1/2 -translate-y-1/2 animate-pulse"
              style={{
                left: `${point.x}%`,
                top: `${point.y}%`
              }}
            />
          )
        ))}

        {/* Obst√°culos */}
        {obstacles.map(obstacle => (
          <div
            key={obstacle.id}
            className={`absolute transform -translate-x-1/2 -translate-y-1/2 shadow-lg rounded-md ${
              obstacle.type === 'bus' 
                ? 'w-16 h-10 bg-blue-600' 
                : 'w-8 h-6 bg-orange-600'
            }`}
            style={{
              left: `${obstacle.x}%`,
              top: `${obstacle.y}%`
            }}
          >
            {obstacle.type === 'bus' && (
              <>
                <div className="absolute top-1 left-1 w-4 h-4 bg-white rounded-sm"></div>
                <div className="absolute top-1 right-1 w-4 h-4 bg-white rounded-sm"></div>
                <div className="absolute bottom-1 left-2 w-3 h-2 bg-black rounded-full"></div>
                <div className="absolute bottom-1 right-2 w-3 h-2 bg-black rounded-full"></div>
                <div className="absolute -top-1 left-4 w-8 h-2 bg-gray-300 rounded"></div>
              </>
            )}
            {obstacle.type === 'animal' && (
              <div className="absolute inset-0 flex items-center justify-center">
                <div className="w-4 h-4 bg-orange-500 rounded-full relative">
                  <div className="absolute top-0 left-1 w-2 h-1 bg-black rounded-full"></div>
                  <div className="absolute top-0 right-1 w-2 h-1 bg-black rounded-full"></div>
                  <div className="absolute bottom-0 left-1 w-1 h-1 bg-black rounded-full"></div>
                  <div className="absolute bottom-0 right-1 w-1 h-1 bg-black rounded-full"></div>
                </div>
              </div>
            )}
          </div>
        ))}

        {/* Carro */}
        <div
          className="absolute w-12 h-8 bg-red-600 rounded-md transform -translate-x-1/2 -translate-y-1/2 shadow-lg"
          style={{
            left: `${carPosition}%`,
            top: '80%'
          }}
        >
          {/* Detalhes do carro */}
          <div className="absolute -top-1 left-2 w-8 h-2 bg-red-700 rounded-sm"></div>
          <div className="absolute bottom-0 left-2 w-3 h-2 bg-black rounded-full"></div>
          <div className="absolute bottom-0 right-2 w-3 h-2 bg-black rounded-full"></div>
        </div>

        {/* Zona de pontos (meio da pista) */}
        <div className="absolute left-0 right-0 h-20 bg-green-500 bg-opacity-20 border-t-2 border-b-2 border-green-400"
             style={{ top: '30%' }}>
          <div className="text-center text-white text-sm font-bold pt-2">
            Colete os pontos!
          </div>
        </div>
      </div>

      {/* Controles */}
      {!isGameRunning ? (
        <button
          onClick={startGame}
          className="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-colors"
        >
          Iniciar Jogo
        </button>
      ) : isMobile ? (
        <div className="mt-6 flex gap-8">
          <button
            onTouchStart={() => handleTouchControl('left')}
            className="bg-gray-600 text-white p-4 rounded-full w-16 h-16 flex items-center justify-center text-2xl shadow-lg active:bg-gray-700"
          >
            ‚Üê
          </button>
          <button
            onTouchStart={() => handleTouchControl('right')}
            className="bg-gray-600 text-white p-4 rounded-full w-16 h-16 flex items-center justify-center text-2xl shadow-lg active:bg-gray-700"
          >
            ‚Üí
          </button>
        </div>
      ) : (
        <div className="mt-6 text-gray-600 text-center">
          Use as setas ‚Üê ‚Üí do teclado para mover
        </div>
      )}

      {/* Instru√ß√µes */}
      <div className="mt-4 text-center text-gray-600">
        <p>Mova o carro para coletar os pontos amarelos!</p>
        <p>Pontos no meio da pista valem 10 pontos cada.</p>
        <p className="text-red-500 font-bold mt-2">üöç Cuidado com os √¥nibus azuis e animais laranja!</p>
        <p className="text-red-500">Se bater, perde todos os pontos! üò±</p>
      </div>

      <style jsx>{`
        .dashed-line {
          background-image: linear-gradient(to bottom, 
            transparent 0%, transparent 50%, 
            yellow 50%, yellow 100%);
          background-size: 100% 20px;
        }
      `}</style>
    </div>
  );
};

export default RacingGame;
